BEGIN;
BEGIN
    SELECT hyperloglog_distinct(id) distinct_estimate_int_sparse FROM generate_series(1,100) s(id);
 distinct_estimate_int_sparse 
------------------------------
              100.00014901102
(1 row)

    SELECT hyperloglog_distinct(id::text) distinct_estimate_text_sparse FROM generate_series(1,100) s(id);
 distinct_estimate_text_sparse 
-------------------------------
               100.00014901102
(1 row)

    SELECT hyperloglog_distinct(id) distinct_estimate_int_dense FROM generate_series(1,100000) s(id);
 distinct_estimate_int_dense 
-----------------------------
            98643.3506821464
(1 row)

    SELECT hyperloglog_distinct(id::text) distinct_estimate_text_dense FROM generate_series(1,100000) s(id);
 distinct_estimate_text_dense 
------------------------------
             98924.8726897958
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i)) accum_sparse1 FROM generate_series(1,1) s(i);
  accum_sparse1   
------------------
 1.00000001490116
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i)) accum_sparse2 FROM generate_series(1,100) s(i);
  accum_sparse2  
-----------------
 100.00014901102
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i)) accum_sparse3 FROM generate_series(1,1020) s(i);
  accum_sparse3   
------------------
 1020.01550348595
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i)) accum_dense1 FROM generate_series(1,10000) s(i);
   accum_dense1   
------------------
 9998.40103485189
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i)) accum_dense2 FROM generate_series(1,100000) s(i);
   accum_dense2   
------------------
 98643.3506821464
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i::text)) accum_dense3 FROM generate_series(1,10000) s(i);
   accum_dense3   
------------------
 10085.1529213667
(1 row)

    SELECT hyperloglog_get_estimate(hyperloglog_accum(i::text)) accum_dense4 FROM generate_series(1,100000) s(i);
   accum_dense4   
------------------
 98924.8726897958
(1 row)

    SELECT 
        hyperloglog_get_estimate(hyperloglog_merge(j.counters)) merge_agg_sparse 
    FROM 
        (SELECT 
            i, 
            hyperloglog_accum(i*400 + m.m) counters 
        FROM 
            generate_series(1,100) s(i) 
        cross join 
            (SELECT 
                m 
            from 
                generate_series(1,400) s(m)) m 
            group by i) j;
 merge_agg_sparse 
------------------
 39955.1597639457
(1 row)

    SELECT 
        hyperloglog_get_estimate(hyperloglog_merge(j.counters)) merge_agg_dense 
    FROM 
        (SELECT 
            i , 
            hyperloglog_accum(i*10000 + m.m) counters 
        FROM 
            generate_series(1,100) s(i) 
        cross join 
            (SELECT 
                m 
            from 
                generate_series(1,10000) s(m)) m 
            group by i) j;
 merge_agg_dense  
------------------
 997108.262338987
(1 row)

    SELECT 
        sum(j.counters) sum_sparse
    FROM
        (SELECT
            i,
            hyperloglog_accum(i*400 + m.m) counters
        FROM
            generate_series(1,100) s(i)
        cross join
            (SELECT
                m
            from
                generate_series(1,400) s(m)) m
            group by i) j;
 sum_sparse 
------------
      39955
(1 row)

    
    SELECT
        sum(j.counters) sum_dense
    FROM
        (SELECT
            i ,
            hyperloglog_accum(i*10000 + m.m) counters
        FROM
            generate_series(1,100) s(i)
        cross join
            (SELECT
                m
            from
                generate_series(1,10000) s(m)) m
            group by i) j;
 sum_dense 
-----------
    997108
(1 row)

    
ROLLBACK;
ROLLBACK
